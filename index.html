<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familien-Wichteln</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Familien-Wichteln</h1>
    <p>Wähle deinen Namen aus:</p>
    <select id="nameSelect">
        <option value="">--Bitte auswählen--</option>
        <option value="Basti">Basti</option>
        <option value="Julia">Julia</option>
        <option value="Dirk">Dirk</option>
        <option value="Steh-Vieh">Steh-Vieh</option>
        <option value="Romy">Romy</option>
        <option value="Christian">Christian</option>
        <option value="Lina">Lina</option>
        <option value="Moritz">Moritz</option>
        <option value="Sissi">Sissi</option>
        <option value="Bartosz">Bartosz</option>
        <option value="David">David</option>
        <option value="Monika">Monika</option>
        <option value="Sascha">Sascha</option>
        <option value="Violetta">Violetta</option>
        <option value="Sammy">Sammy</option>
        <option value="Sven">Sven</option>
        <option value="Angi">Angi</option>
        <option value="Andrea">Andrea</option>
    </select>
    <button id="startButton">Loslegen</button>
    
    <div id="tree">
        <div class="letter" data-name="Basti"></div>
        <div class="letter" data-name="Julia"></div>
        <div class="letter" data-name="Dirk"></div>
        <div class="letter" data-name="Steh-Vieh"></div>
        <div class="letter" data-name="Romy"></div>
        <div class="letter" data-name="Christian"></div>
        <div class="letter" data-name="Lina"></div>
        <div class="letter" data-name="Moritz"></div>
        <div class="letter" data-name="Sissi"></div>
        <div class="letter" data-name="Bartosz"></div>
        <div class="letter" data-name="David"></div>
        <div class="letter" data-name="Monika"></div>
        <div class="letter" data-name="Sascha"></div>
        <div class="letter" data-name="Violetta"></div>
        <div class="letter" data-name="Sammy"></div>
        <div class="letter" data-name="Sven"></div>
        <div class="letter" data-name="Angi"></div>
        <div class="letter" data-name="Andrea"></div>
    </div>

    <!-- Rotes Hintergrundfenster für die Anzeige -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <p id="resultText"></p>
        </div>
    </div>

    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyACPE3mLX_OkWr5dvfPzg7tv2C1rmB7pRo",
            authDomain: "wichteln-94d95.firebaseapp.com",
            databaseURL: "https://wichteln-94d95-default-rtdb.firebaseio.com",
            projectId: "wichteln-94d95",
            storageBucket: "wichteln-94d95.appspot.com",
            messagingSenderId: "1075406306053",
            appId: "1:1075406306053:web:3dca41104574bd7be1156c",
            measurementId: "G-K40DJ2BM6H"
        };

        // Firebase initialisieren
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Teilnehmernamen
        const participants = [
            "Basti", "Julia", "Dirk", "Steh-Vieh", "Romy", 
            "Christian", "Lina", "Moritz", "Sissi", "Bartosz", 
            "David", "Monika", "Sascha", "Violetta", "Sammy", 
            "Sven", "Angi", "Andrea"
        ];

        // Briefe und Status
        const letters = Array.from(document.querySelectorAll('.letter'));
        const assignedNames = {};

        // Funktion, um einen zufälligen Namen zu wählen
        function getRandomName(exclude) {
            const availableNames = participants.filter(name => name !== exclude);
            if (availableNames.length === 0) return null; // Keine verfügbaren Namen
            const randomIndex = Math.floor(Math.random() * availableNames.length);
            return availableNames[randomIndex];
        }

        // Modal-Funktionen
        const modal = document.getElementById("resultModal");
        const resultText = document.getElementById("resultText");
        const closeModal = document.getElementById("closeModal");

        function openModal(name) {
            resultText.textContent = `Du hast ${name} gezogen!`;
            modal.style.display = "block";
        }

        closeModal.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Ergebnisse speichern
        function saveDrawResult(participantId, name) {
            set(ref(database, 'draws/' + participantId), {
                name: name
            });
        }

        // Ziehungen überprüfen
        function checkDraw(participantId) {
            const dbRef = ref(database);
            get(child(dbRef, 'draws/' + participantId)).then((snapshot) => {
                if (snapshot.exists()) {
                    openModal(snapshot.val().name); // Name anzeigen
                } else {
                    drawNewName(participantId); // Neuen Namen ziehen
                }
            }).catch((error) => {
                console.error("Error getting data:", error);
            });
        }

        function drawNewName(participantId) {
            const selectedName = localStorage.getItem('selectedName');
            const recipient = getRandomName(selectedName);
            if (recipient) {
                assignedNames[participantId] = recipient;
                saveDrawResult(participantId, recipient); // Ergebnis speichern
                openModal(recipient); // Modal öffnen
            } else {
                alert("Es gibt keine verfügbaren Teilnehmer mehr.");
            }

            // Briefe nicht mehr klickbar machen
            letters.forEach(l => {
                l.style.pointerEvents = 'none';
            });
        }

        // Event-Listener für den Start-Button
        document.getElementById('startButton').addEventListener('click', () => {
            const selectedName = document.getElementById('nameSelect').value;

            if (!selectedName) {
                alert('Bitte wähle deinen Namen aus!');
                return;
            }

            // Speichere den Namen in Local Storage
            localStorage.setItem('selectedName', selectedName);
            alert(`Du hast ${selectedName} gewählt! Klicke auf einen Brief, um deinen Wichtelpartner zu ziehen.`);
        });

        // Event-Listener für die Briefe
        letters.forEach((letter, index) => {
            letter.addEventListener('click', function() {
                checkDraw(index); // Überprüfen und ggf. ziehen
            });
        });

        // Beim Laden der Seite überprüfen, ob ein Name ausgewählt wurde
        window.onload = () => {
            const selectedName = localStorage.getItem('selectedName');
            if (selectedName) {
                alert(`Willkommen zurück, ${selectedName}!`);
            }
        };
    </script>
</body>
</html>
